name: Build Release

on:
  release:
    types: [created]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask flask-socketio pyautogui pyperclip PyQt5 qrcode[pil] python-engineio pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller server.spec

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build Installer
        run: iscc installer.iss

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer_output/RemoteTouchpad_Windows_Installer.exe

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: installer_output/RemoteTouchpad_Windows_Installer.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask flask-socketio pyautogui pyperclip PyQt5 qrcode[pil] python-engineio pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "Remote Touchpad" \
            --windowed \
            --add-data "webapp:webapp" \
            --add-data "remote-mouse.ico:." \
            --onefile \
            server.py

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -r "dist/Remote Touchpad.app" dmg_contents/ 2>/dev/null || cp "dist/Remote Touchpad" dmg_contents/
          hdiutil create -volname "Remote Touchpad" -srcfolder dmg_contents -ov -format UDZO RemoteTouchpad_Mac.dmg

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: RemoteTouchpad_Mac.dmg

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: RemoteTouchpad_Mac.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev libxcb-xinerama0 libxcb-cursor0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask flask-socketio pyautogui pyperclip PyQt5 qrcode[pil] python-engineio pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "remote-touchpad" \
            --windowed \
            --add-data "webapp:webapp" \
            --add-data "remote-mouse.ico:." \
            --onefile \
            server.py

      - name: Create AppImage
        run: |
          # Download appimagetool and extract it (no FUSE needed)
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy executable
          cp dist/remote-touchpad AppDir/usr/bin/

          # Create desktop file
          echo "[Desktop Entry]" > AppDir/usr/share/applications/remote-touchpad.desktop
          echo "Name=Remote Touchpad" >> AppDir/usr/share/applications/remote-touchpad.desktop
          echo "Exec=remote-touchpad" >> AppDir/usr/share/applications/remote-touchpad.desktop
          echo "Icon=remote-touchpad" >> AppDir/usr/share/applications/remote-touchpad.desktop
          echo "Type=Application" >> AppDir/usr/share/applications/remote-touchpad.desktop
          echo "Categories=Utility;" >> AppDir/usr/share/applications/remote-touchpad.desktop

          # Copy desktop file to AppDir root
          cp AppDir/usr/share/applications/remote-touchpad.desktop AppDir/

          # Create AppRun
          printf '#!/bin/bash\nSELF=$(readlink -f "$0")\nHERE=${SELF%%/*}\nexec "${HERE}/usr/bin/remote-touchpad" "$@"\n' > AppDir/AppRun
          chmod +x AppDir/AppRun

          # Create simple icon (placeholder)
          convert -size 256x256 xc:white AppDir/usr/share/icons/hicolor/256x256/apps/remote-touchpad.png 2>/dev/null || touch AppDir/remote-touchpad.png

          # Build AppImage using extracted appimagetool
          ARCH=x86_64 ./squashfs-root/AppRun AppDir RemoteTouchpad_Linux.AppImage

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: RemoteTouchpad_Linux.AppImage

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: RemoteTouchpad_Linux.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
